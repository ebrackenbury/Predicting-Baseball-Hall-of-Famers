---
title: "Hall of Fame Prediction Analysis"
author: "Evan Brackenbury"
date: "11/15/2021"
output: html_document
---

```{r setup, echo=FALSE, message=FALSE}
library(Lahman)
library(dplyr)
library(tidyr)
library(ggplot2)
library(randomForest)
library(gridExtra)
library(caret)
```

## Data Cleaning and Wrangling

The Lahman packages contains many different tables of baseball data. There are 2
tables we will start with.


```{r cars}
voting <- Lahman::HallOfFame
people <- Lahman::People
```

First, let's took a look at the structure of the voting table and some variables
of interest. 
```{r}
str(voting)
voting$votedBy <- as.factor(voting$votedBy)

summary(voting$votedBy)
summary(voting$inducted)
summary(voting$category)
```

"Inducted" will be the variable we are trying to predict. "Category" and
"votedBy" are relevant because we want to use statistics to build a model. This
means we will want to limit out data to players only. Next, we will limit the
data to include only players who were elected through the Baseball Writers of
America, as players who have been elected through other avenues had
non-statistical factors involved. Last, we can create a separate data frame for
inducted players only.
```{r}
voting <- voting %>%
  filter(category == "Player")

voting <- voting %>%
  filter(votedBy == "BBWAA")

inducted_players <- voting %>%
  filter(inducted == "Y")
```

Next, let's take a look at the "People" table:

```{r}
str(People)
```

Since first and last name are stored in separate columns, we can create a
variable for "full name" which will help identify players easier. We'll also
filter down the data set so it only includes the players that have appeared on a
hall of fame ballot.

```{r}
people$name <- paste(people$nameFirst, people$nameLast)

people <- people %>% 
  filter((playerID %in% voting$playerID))
```

The "People" table doesn't include position, which could be a variable of
interest. This is likely due to players playing multiple positions over the
course of their career. Luckily, we can find position in the "Fielding" table.

```{r}
fielding <- Lahman::Fielding

str(fielding)
```

The table contains aggregated fielding statistics by year. Let's see if there
are any players that have multiple positions in the data:
```{r}
fielding %>% 
  group_by(playerID) %>% 
  summarize(positions = n_distinct(POS)) %>% 
  filter(positions > 1)
```

Lots of players have multiple positions! To address this, we will take the
position with the most games played for each individual player and store that
in a new data frame. Then we will add "position" as a variable in our "People"
table.
```{r, message=FALSE}
player_position <- Fielding %>%
  group_by(playerID, POS) %>% 
  summarize(games = sum(G)) %>% 
  slice(which.max(games)) %>% 
  arrange(desc(games))

people <- merge(people, player_position[c("playerID", "POS")],
                by.x = "playerID")

names(people)[names(people) == "POS"] <- "position"

people$position <- as.factor(people$position)
```


```{r}
summary(people$position)
```

Pitchers are non-pitchers are obviously judged on a different set of statistics.
For now, we will focus on fielders and develop a separate model for pitchers at
some point in the future.

```{r}
fielders <- people %>% 
  filter(position != "P")
```

Now we can pull some stats. Hitting stats can be found in the "Batting" table.

```{r}
batting <- Lahman::Batting
str(batting)
```

There are some NA's present in some of the columns. Let's see how many NA values
there are in each column.

```{r}
colSums(is.na(batting))
```

There are different ways to handle missing values. In this situation, we can
substitute in 0 where there is NA. First, we can create a function that converts
the NA's to 0. Then we can identify the column indices where there are missing
values present. Finally we can apply our function to those columns so there are
no longer missing values in our data.

```{r}
na_to_zero <- function(x){
  x[is.na(x)] <- 0
  return(x)
}

na_cols <- unique(which(is.na(batting), arr.ind = TRUE)[,2])
print(na_cols)

batting[na_cols] <- lapply(batting[na_cols], na_to_zero)
```

Let's confirm the function worked:
```{r}
colSums(is.na(batting))
```

Similar to the "Fielding" table, the "Batting" table is aggregated statistics
for each player and year. Players on the Hall of Fame ballot are judged on their
career stats, so we'll need to aggregate the data up to the player level.

```{r, message=FALSE}
batting_stats <- batting %>%
  group_by(playerID) %>% 
  summarize(batting_seasons = length(unique(yearID)),
            games = sum(G),
            at_bats = sum(AB),
            runs = sum(R),
            hits = sum(H),
            singles = sum(H-(X2B + X3B + HR)),
            doubles = sum(X2B),
            triples = sum(X3B),
            home_runs = sum(HR),
            rbis = sum(RBI),
            stolen_bases = sum(SB),
            caught_stealing = sum(CS),
            walks = sum(BB),
            strikeouts = sum(SO),
            int_walks = sum(IBB),
            hbp = sum(HBP),
            sac_hit = sum(SH),
            sac_fly = sum(SF),
            gidp = sum(GIDP),
            plate_app = sum(AB + BB + SH + SF + HBP))
```

We can also create new variables from those stats.

```{r}
batting_stats <- batting_stats %>%
  mutate(
    average = hits / at_bats,
    on_base = (hits + walks + hbp) / (at_bats + walks + hbp + sac_fly),
    slugging = (singles + 2 * doubles + 3 * triples + 4 * home_runs) /
      at_bats,
    ops = on_base + slugging
  )
```

We can combine our data into a single data frame for use. Let's remove some
columns which are not relevant to this analysis and add in batting stats and the
inducted flag.
```{r}
fielders <- fielders[c("playerID", "name", "position")]

fielders <- merge(fielders, batting_stats, by.x = "playerID")

# Add Inducted
fielders <-
  merge(fielders,
        inducted_players[c("playerID", "inducted")],
        by.x = "playerID",
        all.x = TRUE)

fielders <- fielders %>%
  mutate(inducted = if_else(is.na(inducted), "N", "Y"))

fielders$inducted <- as.factor(fielders$inducted)

str(fielders)
```

There are some more variables that might be relevant to the analysis.
Considering players are generally compared to other players from the same era,
it might make sense to add a variable representing what era each player played
in. We'll calculate which decade each player played in the most games and use
that as our variable.
```{r, message=FALSE}
player_decade <- batting %>%
  mutate(decade = yearID - (yearID %% 10)) %>%
  group_by(playerID, decade) %>%
  summarize(games = sum(G)) %>%
  filter(games == max(games))

fielders <-
  merge(fielders, player_decade[c("playerID", "decade")], by.x = "playerID")
```

Winning awards signifies a great season from a player and enough great seasons
could mean induction into the Hall of Fame. The Lahmen package provides this
data as well. 
```{r}
awards <- Lahman::AwardsPlayers
str(awards)

unique(awards$awardID)
```

For now, we will grab the most recognizable awards. This requires some data
wrangling. Since awards are in a single variable, we can make a column for each
award and sum up the amount of awards per player.
```{r}
awards$one <- 1

awards <- awards %>%
  spread(awardID, one)

awards <- data.frame(lapply(awards, na_to_zero))

awards <- awards %>%
  group_by(playerID) %>%
  summarize(
    All_Star_MVP = sum(All.Star.Game.MVP),
    MVP = sum(Most.Valuable.Player),
    Gold_Glove = sum(Gold.Glove),
    Silver_Slugger = sum(Silver.Slugger),
    Triple_Crown = sum(Triple.Crown),
    World_Series_MVP = sum(World.Series.MVP)
  )

awards <- awards %>%
  mutate(
    All_Star_MVP = if_else(All_Star_MVP > 0, 1, 0),
    MVP = if_else(MVP > 0, 1, 0),
    Gold_Glove = if_else(Gold_Glove > 0, 1, 0),
    Silver_Slugger = if_else(Silver_Slugger > 0, 1, 0),
    Triple_Crown = if_else(Triple_Crown > 0, 1, 0),
    World_Series_MVP = if_else(World_Series_MVP > 0, 1, 0)
  )

fielders <- merge(fielders, awards, by.x = "playerID")
```

Next we'll add is batting titles. Like the Triple Crown, this award is decided
strictly by statistics. The awards is giving to the player in each league
(American League and National League) with the highest batting average, given
they have the minimum number of plate appearances.

Note: Melky Cabrera was suspended in 2012 and was deemed ineligible for the
batting title. He is manually excluded in the code below.

Note2: Due to Covid-19, the 2020 was a shortened season. This meant the plate
appearances requirement had to be adjusted, though we won't be looking at
active players in this analysis.

```{r}
batting_titles <- batting %>%
  filter(paste(yearID, playerID, sep = "") != "2012cabreme01") %>%
  mutate(PA = (AB + BB + SH + SF + HBP),
         BA = H / AB) %>%
  group_by(yearID, playerID, lgID) %>%
  mutate(BA = ifelse(yearID != 2020, ifelse(PA >= 502, BA, H / ((
    502 - PA
  ) + AB)),
  ifelse(PA >= 186, BA, H / ((
    186 - PA
  ) + AB)))) %>%
  ungroup() %>%
  group_by(yearID, lgID) %>%
  filter(BA == max(BA)) %>%
  group_by(playerID) %>%
  summarize(titles = n()) %>%
  arrange(desc(titles))


fielders <-
  merge(fielders, batting_titles, by = "playerID", all.x =  TRUE)

fielders$batting_titles <- na_to_zero(fielders$titles)
```

The last variable we will add for now is World Series Titles. 

```{r}
world_series_by_player <- batting %>%
  group_by(yearID, playerID) %>%
  filter(stint == max(stint))

world_series_by_player <-
  merge(
    world_series_by_player,
    SeriesPost[SeriesPost$round == "WS",
               c("yearID", "teamIDwinner",
                 "round")],
    by.x = c("yearID", "teamID"),
    by.y = c("yearID", "teamIDwinner"),
    all.x = TRUE
  )

world_series_by_player <- world_series_by_player %>%
  mutate(round = if_else(is.na(world_series_by_player$round), 0, 1)) %>%
  rename(WS = round) %>%
  group_by(playerID) %>%
  summarize(WS_wins = sum(WS)) %>%
  select(playerID, WS_wins)

fielders <-
  merge(fielders,
        world_series_by_player,
        by = "playerID",
        all.x = TRUE)
```

We are now ready to start exploring our variables to see which ones are
correlated with being inducted into the Hall of Fame.

## Exploritory Data Analysis

```{r pressure, echo=FALSE}
```




